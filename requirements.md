# イメージボード作成ツール 要件定義書

## 1. プロジェクト概要

### 目的
デザイナーの業務効率化のため、画像から類似画像を効率的に検索・配置できるイメージボード作成ツールを開発する。

### 主要機能
- 画像アップロード（ドラッグ&ドロップ）
- AIによる画像分析（Gemini使用）
- 分析結果の可視化（カラーパレット含む）
- Pinterestからの類似画像検索・表示
- フリーボード形式での画像配置（Miro風）

---

## 2. 機能要件

### 2.1 画像アップロード機能
- **対応形式**: JPG, PNG, GIF, WebP等の主要画像形式
- **アップロード方法**: ドラッグ&ドロップ対応
- **複数画像対応**: 
  - 初期実装では1画像ずつ処理（将来的に複数画像対応を検討）
  - 複数画像をアップロードした場合、最初の1枚を処理対象とする
- **表示**: アップロードした画像を中央に表示
- **ファイルサイズ制限**: 10MB（設定可能）
- **バリデーション**: ファイル形式とサイズのチェック

### 2.2 画像分析機能（Gemini API使用）

#### 分析項目
各画像について以下の情報を分析・言語化：

1. **カラー**
   - 主要カラーの抽出（5-7色程度）
   - カラーパレットの可視化（色見本として表示）
   - 各色のHEXコード・RGB値の表示（コピー可能）

2. **質感・スタイル**
   - テクスチャ、素材感の言語化
   - デザインスタイルの分類

3. **トーン＆ムード**
   - 全体的な雰囲気、感情的なトーンの言語化

4. **レイアウト特性**（必要に応じて）
   - 構図、配置パターンの分析

#### 分析結果の表示
- **表示タイミング**: アップロード完了後、自動的に分析開始
- **表示位置**: 元画像の下に分析結果パネルを表示
- **表示形式**:
  - 各分析項目をカード形式で表示
  - アイコンを使用して視覚的に区別（🎨 カラー、🎭 質感・スタイル、💫 トーン＆ムード）
  - カラーパレット: 円形または四角形で表示、ホバーで拡大表示
  - テキスト情報: 折りたたみ可能にして、必要に応じて詳細を表示
- **ローディング状態**:
  - スケルトンローディングまたはプログレスバー
  - 「画像を分析中...」メッセージ
  - 分析項目ごとの進捗表示（カラー分析中、質感分析中など）

### 2.3 類似画像検索機能

#### 検索軸の選択
- **選択UI**: 分析結果パネル内のプラスボタン（「+ 検索軸を選択」）から選択
- **選択方法**: ドロップダウンメニューまたはモーダル形式
- **選択可能な軸**:
  - カラー軸
  - 質感・スタイル軸
  - トーン＆ムード軸
  - レイアウト特性軸
- **ツールチップ**: ホバーで「検索軸を選択」などの説明を表示

#### 検索処理
- **検索方法**: Pinterest検索（API不使用）
- **検索クエリ生成**: 
  - 分析結果のテキストから自動生成
  - プロンプトは固定化（実験しながら最適化）
  - 検索クエリをユーザーが確認できるように表示
- **取得画像数**: 各軸につき5枚（固定）
- **ローディング状態**:
  - 「類似画像を検索中...」メッセージ
  - 検索軸ごとの進捗表示
  - 取得済み画像数の表示（例: 3/5枚取得済み）

#### 検索結果の表示
- **表示情報**: 
  - 画像サムネイル
  - Pinterestの画像URL（クリックで元ページを開く）
- **グループ化**: 各検索軸ごとにグループ化して表示
- **グループタイトル**: 「カラー軸の検索結果」などのタイトルを表示
- **初期配置**: 元画像の周辺（上下左右）に自動的にグリッド配置
- **グリッド間隔**: 適切な間隔を設定

#### 検索結果の操作
- **個別削除**: 各画像に削除ボタンを配置
- **グループ削除**: 検索軸ごとの一括削除ボタン
- **再検索**: 検索結果の再検索機能（別のクエリで再検索）
- **検索履歴**: 検索した軸を記録し、再度検索可能にする

### 2.4 UI/UX要件

#### レイアウト
- **基本レイアウト**: 
  - 中央に元画像を配置
  - 元画像の下に分析結果パネルを配置
  - 周辺に類似画像を配置（シンプルなグリッド配置）
- **類似画像の表示**: グリッド形式
- **画像表示**: ツール内で画像を直接表示（Pinterestの画像URLを使用）

#### 画像の操作
- **ドラッグ&ドロップ**: 
  - 画像をドラッグして自由に移動可能
  - ドラッグ中は半透明表示
  - ドロップ位置にスナップ機能（グリッドに合わせる）
  - ドラッグ中に他の画像との重なりを表示
- **画像選択**: 
  - クリックで画像を選択（選択状態を視覚的に表示）
  - 選択した画像を削除可能（Deleteキーまたは削除ボタン）
- **画像クリック**: Pinterestの元ページを新しいタブで開く
- **画像サイズ**: 固定サイズ（将来的にリサイズ機能を検討）

#### レスポンシブデザイン
- **デスクトップ**: 横長レイアウト、複数画像を並列表示
- **タブレット**: 2列レイアウト
- **モバイル**: 
  - 1列レイアウト、縦スクロール
  - タッチ操作でのドラッグ&ドロップ対応
  - 検索結果を縦に並べて表示

#### アクセシビリティ
- **キーボード操作**: 
  - Tabキーで要素間を移動
  - Enter/Spaceで選択
  - Deleteキーで画像削除
  - 矢印キーで画像を移動（オプション）
- **スクリーンリーダー対応**:
  - 適切なaria-labelを設定
  - 画像のalt属性を設定
  - 分析結果をテキストで読み上げ可能に
- **色のコントラスト**: WCAG 2.1 AA基準を満たす
- **カラーパレット**: 色名もテキストで表示

#### エラーハンドリング
- **分析失敗時**: 
  - 「分析に失敗しました。もう一度お試しください」メッセージ
  - リトライボタンを表示
- **検索失敗時**: 
  - 「検索に失敗しました。別の検索軸をお試しください」メッセージ
  - リトライボタンを表示
- **ネットワークエラー**: 
  - 「接続エラーが発生しました」メッセージ
  - 再接続ボタンを表示

#### その他
- **保存機能**: 不要（PinterestのURLがあれば十分）
- **将来的な拡張案**:
  - スクリーンショット機能（現在のボードを画像として保存）
  - 画像URLの一括コピー
  - 分析結果のテキストコピー

---

## 3. 技術要件

### 3.1 AIサービス
- **画像分析**: Google Gemini API（Vision機能）

### 3.2 画像検索
- **検索先**: Pinterest
- **検索方法**: API不使用（スクレイピングまたは検索URL生成）

### 3.3 技術スタック（確定）

#### フロントエンド
- **フレームワーク**: Next.js 14+ (App Router)
- **UIライブラリ**: 
  - React DnD または @dnd-kit/core (ドラッグ&ドロップ)
  - Tailwind CSS (スタイリング)
  - shadcn/ui (UIコンポーネント、オプション)

#### バックエンド
- **API**: Next.js API Routes
- **画像処理**: Sharp (画像リサイズ・最適化)

#### インフラ（GCP）
- **ホスティング**: Cloud Run
  - Next.jsアプリケーションをコンテナ化してデプロイ
  - 自動スケーリング対応
  - サーバーレス運用
- **ストレージ**: Cloud Storage（必要に応じて一時的な画像保存）
- **認証**: 不要（現時点）

#### 外部API・サービス
- **AI分析**: Google Gemini API (gemini-pro-vision)
- **画像検索**: Pinterest（検索URL生成 → サーバーサイドで画像取得）

### 3.4 その他
- **ユーザー認証**: 不要
- **データ保存**: 不要（セッション内のみ）
- **環境変数管理**: GCP Secret Manager（APIキー管理）

---

## 4. 技術的課題と検討事項

### 4.1 Pinterest検索の実装方法（確定: オプションAベース）

#### 実装方式
1. **検索クエリ生成**
   - 分析結果（カラー、質感、トーン等）から検索クエリを自動生成
   - プロンプトは固定化（実験しながら最適化）

2. **Pinterest検索URL生成**
   - 生成したクエリからPinterest検索URLを作成
   - 例: `https://www.pinterest.jp/search/pins/?q={検索クエリ}`

3. **画像取得（サーバーサイド）**
   - Next.js API RouteでPinterest検索結果ページにアクセス
   - HTMLをパースして画像URLを抽出
   - 各軸につき5枚の画像URLを取得

4. **画像表示**
   - 取得した画像URLをフロントエンドで表示
   - Pinterestの画像URLも保持（リンク用）

#### 技術的実装
- **HTMLパース**: Cheerio または Puppeteer（必要に応じて）
- **画像プロキシ**: 必要に応じてNext.js API Routeで画像をプロキシング
- **エラーハンドリング**: Pinterestのアクセス制限やレート制限への対応

#### 注意事項
- Pinterestの利用規約を確認（スクレイピングの可否）
- レート制限への対応（リクエスト間隔の調整）
- 将来的にPinterest APIへの移行を検討

---

## 5. 実装フェーズ

### Phase 1: 基盤構築
- Next.jsプロジェクトのセットアップ
- GCP Cloud Runへのデプロイ環境構築
- 基本的なUIレイアウトの実装
- Tailwind CSS、@dnd-kit/core等のライブラリ導入

### Phase 2: コア機能実装
- 画像アップロード機能（ドラッグ&ドロップ）
- ファイルバリデーション（形式・サイズチェック）
- Gemini APIによる画像分析
- ローディング状態の表示
- 分析結果の表示（カラーパレット含む）
- 検索クエリ生成ロジックの実装

### Phase 3: Pinterest検索機能
- 検索軸選択UIの実装（ドロップダウンメニュー）
- Pinterest検索URL生成
- サーバーサイドでの画像取得（Cheerio使用）
- 画像の表示機能
- 検索結果のグループ化表示
- ローディング状態の表示

### Phase 4: UI/UX改善
- グリッド表示の実装
- ドラッグ&ドロップ対応（@dnd-kit/core）
- 画像選択・削除機能
- 検索結果の削除機能（個別・グループ）
- エラーハンドリングとリトライ機能
- レスポンシブデザイン（モバイル対応）

### Phase 5: アクセシビリティ・最適化
- キーボード操作対応
- スクリーンリーダー対応（aria-label、alt属性）
- 色のコントラスト調整（WCAG 2.1 AA準拠）
- プロンプトの最適化
- 検索精度の向上
- パフォーマンス改善
- エラーハンドリングの強化

### Phase 6: 将来的な拡張（オプション）
- 複数画像の同時処理
- 画像のリサイズ機能
- スクリーンショット機能
- 画像URLの一括コピー
- 分析結果のテキストコピー

---

## 6. アーキテクチャ概要

### 6.1 システム構成図
```
[ユーザー]
    ↓
[Next.js Frontend (Cloud Run)]
    ├→ [Gemini API] (画像分析)
    └→ [Next.js API Routes]
        └→ [Pinterest] (検索結果取得)
            └→ [画像URL抽出]
                └→ [Frontend表示]
```

### 6.2 主要なAPIエンドポイント（想定）
- `POST /api/analyze` - 画像分析（Gemini API呼び出し）
- `POST /api/search/pinterest` - Pinterest検索（画像取得）
- `GET /api/image/proxy` - 画像プロキシング（必要に応じて）

### 6.3 データフロー（詳細）

#### 画像アップロード・分析フロー
1. ユーザーが画像をドラッグ&ドロップでアップロード
2. ファイル形式・サイズのバリデーション
3. アップロード完了 → 自動的に分析開始
4. ローディング状態を表示（「画像を分析中...」）
5. フロントエンド → `/api/analyze` に画像を送信
6. バックエンドがGemini APIを呼び出して分析
7. 分析結果をフロントエンドに返却
8. 分析結果パネルを表示（カラーパレット、テキスト情報）
9. プラスボタン（「+ 検索軸を選択」）を表示

#### 類似画像検索フロー
1. ユーザーがプラスボタンをクリック
2. 検索軸選択UIを表示（ドロップダウンメニューまたはモーダル）
3. ユーザーが検索軸を選択
4. ローディング状態を表示（「類似画像を検索中...」）
5. フロントエンド → `/api/search/pinterest` に検索クエリを送信
6. バックエンドがPinterestから画像を取得
7. 画像URLをフロントエンドに返却
8. 検索結果をグループ化してグリッド表示
9. ユーザーが画像をドラッグして配置調整

---

## 7. 技術的考慮事項

### 7.1 プロンプト管理
- **管理方法**: 設定ファイル（`prompts.ts`）で管理
- **最適化**: 実験しながらプロンプトを調整
- **バージョン管理**: Gitで管理し、変更履歴を追跡

### 7.2 セキュリティ
- **APIキー管理**: GCP Secret Managerを使用
- **画像アップロード**: ファイルサイズ制限、形式チェック
- **CORS**: 適切なCORS設定

### 7.3 パフォーマンス
- **画像最適化**: Sharpによるリサイズ・圧縮
- **キャッシング**: 分析結果の一時的なキャッシュ（必要に応じて）
- **非同期処理**: 画像分析と検索を非同期で処理

### 7.4 エラーハンドリング

#### APIエラー
- **Gemini API**: 
  - レート制限への対応（リトライロジック）
  - エラー時のリトライ（最大3回）
  - タイムアウト処理（30秒）
- **Pinterest**: 
  - アクセス制限への対応
  - HTMLパースエラー時の処理
  - レート制限への対応（リクエスト間隔の調整）

#### ユーザー通知
- **分析失敗時**: 
  - 「分析に失敗しました。もう一度お試しください」メッセージ
  - リトライボタンを表示
- **検索失敗時**: 
  - 「検索に失敗しました。別の検索軸をお試しください」メッセージ
  - リトライボタンを表示
- **ネットワークエラー**: 
  - 「接続エラーが発生しました」メッセージ
  - 再接続ボタンを表示
- **ファイルエラー**: 
  - 「対応していないファイル形式です」メッセージ
  - 「ファイルサイズが大きすぎます（最大10MB）」メッセージ

---

## 8. UI/UX詳細設計

### 8.1 画面レイアウト

```
┌─────────────────────────────────────────────────────┐
│  イメージボード作成ツール                            │
├─────────────────────────────────────────────────────┤
│                                                      │
│              ┌──────────────┐                       │
│              │              │                       │
│              │   元画像     │                       │
│              │              │                       │
│              └──────────────┘                       │
│                   ↓                                  │
│         ┌────────────────────┐                      │
│         │ 分析結果           │                      │
│         │                    │                      │
│         │ 🎨 カラー          │                      │
│         │ [色見本]           │                      │
│         │                    │                      │
│         │ 🎭 質感・スタイル  │                      │
│         │ ナチュラル、木目調 │                      │
│         │                    │                      │
│         │ 💫 トーン＆ムード  │                      │
│         │ 温かみ、落ち着いた │                      │
│         │                    │                      │
│         │ [+ 検索軸を選択]   │                      │
│         └────────────────────┘                      │
│                                                      │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐              │
│  │画像│ │画像│ │画像│ │画像│ │画像│              │
│  │ 1  │ │ 2  │ │ 3  │ │ 4  │ │ 5  │              │
│  └────┘ └────┘ └────┘ └────┘ └────┘              │
│  カラー軸の検索結果 [削除]                          │
│                                                      │
└─────────────────────────────────────────────────────┘
```

### 8.2 ユーザーフロー

```
1. 画像アップロード（ドラッグ&ドロップ）
   ↓
2. アップロード完了 → 自動的に分析開始（ローディング表示）
   ↓
3. 分析完了 → 元画像の下に分析結果パネルを表示
   ↓
4. プラスボタンが表示 → クリックで検索軸選択
   ↓
5. 検索軸選択 → ローディング表示 → 類似画像をグリッドで表示
   ↓
6. 画像をドラッグして配置調整
   ↓
7. 必要に応じて追加の検索軸で検索
   ↓
8. 不要な画像や検索結果を削除
```

### 8.3 検索軸選択UI

**ドロップダウンメニュー形式（推奨）:**
```
[+ 検索軸を選択 ▼]
  ├─ 🎨 カラー軸
  ├─ 🎭 質感・スタイル軸
  ├─ 💫 トーン＆ムード軸
  └─ 📐 レイアウト特性軸
```

**モーダル形式（代替案）:**
```
┌──────────────────────┐
│ 検索軸を選択          │
├──────────────────────┤
│ ○ 🎨 カラー軸        │
│ ○ 🎭 質感・スタイル軸│
│ ○ 💫 トーン＆ムード軸│
│ ○ 📐 レイアウト特性軸│
│                      │
│ [キャンセル] [検索]  │
└──────────────────────┘
```

---

## 9. 次のステップ

1. ✅ 技術スタック確定（Next.js + GCP Cloud Run）
2. ✅ Pinterest検索方法確定（検索URL生成 → 画像取得）
3. ✅ UI要件確定（グリッド配置 + ドラッグ&ドロップ）
4. ✅ UX要件確定（ローディング、エラーハンドリング、アクセシビリティ）
5. **プロジェクト初期化**: Next.jsプロジェクトの作成
6. **GCP環境構築**: Cloud Runのセットアップ
7. **開発開始**: Phase 1から順次実装

